<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML2RSS - 现代化网页转RSS订阅工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', -apple-system, sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .xml-tag { color: #f472b6; }
        .xml-attr { color: #fbbf24; }
        .xml-string { color: #34d399; }
        .xml-cdata { color: #818cf8; font-style: italic; }
        .glass-effect { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .btn-transition { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-transition:hover { transform: translateY(-1px); }
        .btn-transition:active { transform: translateY(0); }
    </style>
</head>
<body class="bg-[#f8fafc] min-h-screen text-slate-800 selection:bg-indigo-100 selection:text-indigo-700">
    <div class="max-w-4xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="text-center mb-10">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-white rounded-2xl shadow-sm mb-4 border border-slate-100">
                <i class="fas fa-rss text-3xl text-orange-500"></i>
            </div>
            <h1 class="text-4xl font-extrabold text-slate-900 mb-3 tracking-tight">HTML2RSS</h1>
            <p class="text-slate-500 font-medium">高效、简洁、智能的网页 RSS 提取方案</p>
        </div>

        <div class="bg-white shadow-xl shadow-slate-200/50 rounded-3xl overflow-hidden border border-slate-200/60 glass-effect">
            <div class="p-6 sm:p-10">
                <form id="rssForm" onsubmit="return generateRss(event)" class="space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                        <!-- Verification Code - Moved to top -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-bold text-indigo-700 mb-2 ml-1 flex items-center">
                                <i class="fas fa-shield-halved mr-2"></i>访问验证码 (必填)
                            </label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                    <i class="fas fa-key text-slate-400"></i>
                                </div>
                                <input type="password" id="code" required placeholder="请输入安全校验码以启用所有功能"
                                    class="block w-full pl-11 pr-4 py-3.5 bg-indigo-50/50 border border-indigo-100 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all shadow-sm font-medium">
                            </div>
                        </div>

                        <!-- URL Input -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-bold text-slate-700 mb-2 ml-1">网页地址 (URL)</label>
                            <div class="flex space-x-3">
                                <div class="relative flex-grow">
                                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                        <i class="fas fa-link text-slate-400"></i>
                                    </div>
                                    <input type="url" id="url" required placeholder="https://example.com/movies" 
                                        class="block w-full pl-11 pr-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all shadow-sm">
                                </div>
                                <button type="button" onclick="autoDetect()" id="detectBtn"
                                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3.5 rounded-xl font-bold btn-transition shadow-lg shadow-indigo-200 flex items-center space-x-2 whitespace-nowrap">
                                    <i class="fas fa-wand-magic-sparkles"></i>
                                    <span class="hidden sm:inline">智能识别</span>
                                </button>
                            </div>
                        </div>

                        <!-- Selectors -->
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-slate-700 ml-1">链接选择器 (Required)</label>
                            <input type="text" id="a" required placeholder="a[href^=magnet]" 
                                class="block w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all shadow-sm">
                            <p class="text-[11px] text-slate-400 px-1">例如: .movie-list a[href*=torrent]</p>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-slate-700 ml-1">标题选择器 (Optional)</label>
                            <input type="text" id="t" placeholder="div.item > h3" 
                                class="block w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all shadow-sm">
                            <p class="text-[11px] text-slate-400 px-1">如果不填，则尝试从链接文字提取</p>
                        </div>

                        <!-- Attributes & Charset -->
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-slate-700 ml-1">链接属性</label>
                            <input type="text" id="attr" placeholder="href" 
                                class="block w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all shadow-sm">
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-slate-700 ml-1">网页编码</label>
                            <input type="text" id="charset" placeholder="auto" value="auto"
                                class="block w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all shadow-sm">
                        </div>

                        <!-- Sorting -->
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-slate-700 ml-1">标题排序</label>
                            <select id="ts" class="block w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none appearance-none cursor-pointer transition-all shadow-sm">
                                <option value="a">升序 (正序)</option>
                                <option value="d">降序 (倒序)</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-slate-700 ml-1">链接排序</label>
                            <select id="as" class="block w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none appearance-none cursor-pointer transition-all shadow-sm">
                                <option value="a">升序 (正序)</option>
                                <option value="d">降序 (倒序)</option>
                            </select>
                        </div>

                        <!-- Clean Mode Toggle -->
                        <div class="md:col-span-2 flex items-center p-4 bg-orange-50 rounded-2xl border border-orange-100">
                            <div class="flex-grow">
                                <h4 class="text-sm font-bold text-orange-900">纯净阅读模式 (小说/文章推荐)</h4>
                                <p class="text-xs text-orange-700">启用后，RSS 链接将指向本工具提供的无广告阅读界面</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="clean" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-orange-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div>
                            </label>
                        </div>
                    </div>

                    <div class="pt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button type="button" onclick="testRss()" id="testBtn" class="bg-white hover:bg-slate-50 text-slate-700 font-bold py-4 px-6 rounded-2xl transition-all border-2 border-slate-100 flex items-center justify-center space-x-2">
                            <i class="fas fa-vial"></i>
                            <span>预览测试</span>
                        </button>
                        <button type="submit" class="bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-4 px-6 rounded-2xl transition-all shadow-lg shadow-orange-200 flex items-center justify-center space-x-2">
                            <i class="fas fa-bolt"></i>
                            <span>生成最终订阅地址</span>
                        </button>
                    </div>
                </form>

                <!-- Preview Section -->
                <div id="previewArea" class="mt-12 hidden space-y-4 animate-[fadeIn_0.3s_ease-out]">
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-bold text-slate-800 flex items-center">
                            <span class="w-1.5 h-6 bg-indigo-500 rounded-full mr-3"></span>
                            数据预览 (RSS Items)
                        </h3>
                        <button onclick="document.getElementById('previewArea').classList.add('hidden')" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 text-slate-400 transition-colors">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="bg-[#0f172a] rounded-2xl p-5 overflow-hidden border border-slate-800 shadow-2xl">
                        <pre id="xmlPreview" class="text-xs sm:text-[13px] text-indigo-300 overflow-auto max-h-[400px] custom-scrollbar leading-relaxed font-mono"></pre>
                    </div>
                </div>

                <!-- Result Section -->
                <div id="resultArea" class="mt-12 hidden space-y-4 animate-[slideUp_0.3s_ease-out]">
                    <div class="p-6 bg-emerald-50 border border-emerald-100 rounded-3xl">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-base font-bold text-emerald-900">生成成功！您的订阅链接如下</h3>
                            <span class="text-[11px] font-bold text-emerald-700 bg-emerald-100 px-2.5 py-1 rounded-full uppercase tracking-wider">Ready</span>
                        </div>
                        <div class="flex space-x-3">
                            <input type="text" id="rssResult" readonly 
                                class="block w-full px-4 py-3.5 bg-white border border-emerald-200 rounded-xl text-sm text-emerald-800 focus:outline-none font-medium shadow-inner">
                            <button onclick="copyToClipboard()" id="copyBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-3.5 rounded-xl font-bold transition-all shadow-md shadow-emerald-200 flex items-center space-x-2">
                                <i class="fas fa-copy"></i>
                                <span>复制</span>
                            </button>
                        </div>
                        <p class="mt-3 text-xs text-emerald-600 font-medium">提示：请将此链接填入 qBittorrent 或其他 RSS 阅读器中。</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-12 text-center text-slate-400 text-sm font-medium">
            <p>&copy; 2026 HTML2RSS Tools &bull; 精简 &bull; 智能 &bull; 开源</p>
        </div>
    </div>

    <script>
        const BASE62 = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";

        function encodeBase62(bigint) {
            if (bigint === 0n) return BASE62[0];
            let result = "";
            const base = BigInt(BASE62.length);
            while (bigint > 0n) {
                result = BASE62[Number(bigint % base)] + result;
                bigint = bigint / base;
            }
            return result;
        }

        function stringToBigInt(str) {
            const bytes = new TextEncoder().encode(str);
            let hex = "";
            bytes.forEach(b => hex += b.toString(16).padStart(2, '0'));
            return BigInt("0x" + hex);
        }

        function getEncodedParams() {
            const params = {};
            const fields = ['url', 'a', 't', 'code', 'charset', 'ts', 'as', 'attr'];
            fields.forEach(field => {
                const el = document.getElementById(field);
                if (el && el.value) params[field] = el.value;
            });
            
            // Add clean mode toggle
            params['clean'] = document.getElementById('clean').checked;
            
            const jsonStr = JSON.stringify(params);
            const bigInt = stringToBigInt(jsonStr);
            return encodeBase62(bigInt);
        }

        async function autoDetect() {
            const url = document.getElementById('url').value;
            const code = document.getElementById('code').value;
            if (!url) {
                showNotification('请先输入网页地址', 'error');
                return;
            }
            if (!code) {
                showNotification('请先输入访问验证码', 'error');
                return;
            }

            const btn = document.getElementById('detectBtn');
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch(`/detect?url=${encodeURIComponent(url)}&code=${encodeURIComponent(code)}`);
                const data = await response.json();

                if (data.error) {
                    showNotification('识别失败: ' + data.error, 'error');
                } else {
                    if (data.a) document.getElementById('a').value = data.a;
                    if (data.t) document.getElementById('t').value = data.t;
                    if (data.attr) document.getElementById('attr').value = data.attr;
                    showNotification(data.message || '识别成功！', 'success');
                }
            } catch (err) {
                showNotification('网络错误，请稍后重试', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }

        async function testRss() {
            if (!document.getElementById('url').value) {
                showNotification('请先输入网页地址', 'error');
                return;
            }

            const btn = document.getElementById('testBtn');
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>处理中...';

            try {
                const encoded = getEncodedParams();
                const response = await fetch(`/html2rss?p=${encoded}`);
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || '测试失败');
                }
                
                const xml = await response.text();
                const previewArea = document.getElementById('previewArea');
                const xmlPreview = document.getElementById('xmlPreview');
                
                xmlPreview.innerHTML = highlightXml(formatXml(xml));
                previewArea.classList.remove('hidden');
                setTimeout(() => previewArea.scrollIntoView({ behavior: 'smooth' }), 100);
            } catch (err) {
                showNotification(err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }

        function generateRss(e) {
            e.preventDefault();
            
            const encoded = getEncodedParams();
            const baseUrl = window.location.origin + window.location.pathname.replace('index.html', '').replace(/\/$/, '');
            const rssUrl = `${baseUrl}/html2rss?p=${encoded}`;
            
            const resultArea = document.getElementById('resultArea');
            document.getElementById('rssResult').value = rssUrl;
            
            resultArea.classList.remove('hidden');
            setTimeout(() => resultArea.scrollIntoView({ behavior: 'smooth' }), 100);
        }

        function showNotification(msg, type = 'success') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-indigo-600' : 'bg-rose-600';
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            
            toast.className = `fixed top-6 right-6 ${bgColor} text-white px-6 py-4 rounded-2xl shadow-2xl z-50 flex items-center space-x-3 animate-[slideIn_0.3s_ease-out]`;
            toast.innerHTML = `<i class="fas ${icon} text-xl"></i><span class="font-bold">${msg}</span>`;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('animate-[fadeOut_0.3s_ease-in]');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function formatXml(xml) {
            let formatted = '';
            let indent = '';
            const tab = '  ';
            xml.split(/>\s*</).forEach(node => {
                if (node.match(/^\/\w/)) indent = indent.substring(tab.length);
                formatted += indent + '<' + node + '>\n';
                if (node.match(/^<?\w[^>]*[^\/]$/) && !node.match(/^meta/)) indent += tab;
            });
            return formatted.substring(1, formatted.length - 3);
        }

        function highlightXml(xml) {
            return xml
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/(&lt;\[CDATA\[[\s\S]*?\]\]&gt;)/g, '<span class="xml-cdata">$1</span>')
                .replace(/(&lt;\/?[a-zA-Z0-9:]+)/g, '<span class="xml-tag">$1</span>')
                .replace(/(&gt;)/g, '<span class="xml-tag">$1</span>')
                .replace(/\s([a-zA-Z0-9:]+)=/g, ' <span class="xml-attr">$1</span>=')
                .replace(/"([^"]*)"/g, '<span class="xml-string">"$1"</span>');
        }

        async function copyToClipboard() {
            const copyText = document.getElementById("rssResult");
            try {
                await navigator.clipboard.writeText(copyText.value);
                const btn = document.getElementById('copyBtn');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> <span>已复制</span>';
                btn.classList.replace('bg-emerald-600', 'bg-indigo-600');
                
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.classList.replace('bg-indigo-600', 'bg-emerald-600');
                }, 2000);
            } catch (err) {
                showNotification('复制失败，请手动复制', 'error');
            }
        }

        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('code')) document.getElementById('code').value = urlParams.get('code');
        };
    </script>
    <style>
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    </style>
</body>
</html>